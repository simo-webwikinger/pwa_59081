<template>
  <NuxtLayout name="default" :hero="false">
    <template v-slot:hero>
      <!-- title -->
      <div class="relative flex flex-col justify-center min-h-[24rem] p-4 lg:p-8 z-10">
        <h1
          class="text-5xl sm:text-7xl md:text-8xl xl:text-10xl font-black text-white uppercase after:block after:w-[2em] after:h-[0.1em] after:mt-4 after:ml-1.5 after:bg-secondary-500 [hyphens:auto]"
        >
          Kontakt
        </h1>
      </div>
    </template>
    <section class="relative overflow-hidden text-white md:text-lg text-sm">
      <div class="relative container mx-auto px-4">
        <h2 class="md:rich-text typography-headline-2 font-bold uppercase">Geschäftsstelle</h2>
        <div>
          <div>
            <div class="*:py-2">
              <p><strong>American Sports Club Kiel e.V.</strong><br />Hasseldieksdammer Weg 165<br />24114 Kiel</p>
              <p>Eingetragen beim AG Kiel - Vereinsregister<br /><strong>Registernummer: 502 VR 3280</strong></p>
              <p>
                Mail:&nbsp;<a href="javascript:linkTo_UnCryptMailto('rknopwjzVxwhpey3dqnneywjao4za', -22)"
                  >vorstand (at) baltic-hurricanes.de</a
                >
              </p>
            </div>
          </div>
          <h2 class="md:rich-text typography-headline-2 font-bold py-3 uppercase">Vorstand</h2>
          <div>
            <div class="*:py-2">
              <p><strong>1. Vorsitzende</strong><br /><strong>Irene Nagel</strong></p>
              <p><strong>2. Vorstandsmitglied</strong><br /><strong>Marc Lötzerich</strong></p>
              <p><strong>3. Vorstandsmitglied</strong><br />Oliver Riemer</p>
              <p><strong>4. Vorstandsmitglied&nbsp;</strong><br /><strong>Michael Frey Jr.</strong></p>
              <p>
                <br /><strong>Mitgliederverwaltung</strong><br />E-Mail:
                <a
                  href="javascript:linkTo_UnCryptMailto('hdobgdzyzmqzmrvgopibUwvgodx2cpmmdxvizn3yz', -21)"
                  class="text-secondary-500"
                  >mitgliederverwaltung (at) baltic-hurricanes.de</a
                >
              </p>
              <p>&nbsp;</p>
            </div>
          </div>
          <h2 class="rich-text uppercase">PRESSE</h2>
          <div>
            <div>
              <p>
                Pressekontakt GFL Team<br />Bettina Büll<br />E-Mail:
                <a href="javascript:linkTo_UnCryptMailto('tlkphalhtGihsapj4obyypjhulz5kl', -7)"
                  >mediateam(at)baltic-hurricanes.de</a
                >
              </p>
              <p>Für Akkreditierungswünsche bitte eine Email mit dem/den betreffenden Spiel/en senden.</p>
              <p>&nbsp;</p>
            </div>
          </div>
          <h2 class="rich-text uppercase">ASC Kiel</h2>
          <div>
            <div>
              <p>Ansprechpartner: &nbsp;</p>
              <p>
                <strong>Cheerleading:</strong><br />Birgit Stojalowski<br /><a
                  href="javascript:linkTo_UnCryptMailto('purreyrnqvatMonygvp:uheevpnarf+qr', -13)"
                  >cheeleading (at) baltic-hurricanes.de</a
                ><br /><br /><strong>Hurricanes U19 A-Jugend:</strong><br />Berit Wunder und Andrea Hensel<br /><a
                  href="javascript:linkTo_UnCryptMailto('wnt9g-5Lnmxfuo9tgdduomzqe:pq', -12)"
                  >kbh-u19 (at) baltic-hurricanes.de</a
                ><br /><br /><strong>Hurricanes U16 B-Jugend:</strong><br />Klaus Kufalt &amp; Tim Steiner &amp; Stefan
                Blank-Böger<br /><a href="javascript:linkTo_UnCryptMailto('vms8f,1Kmlwetn8sfcctnlypd9op', -11)"
                  >kbh-u16 (at) baltic-hurricanes.de</a
                ><br /><br /><strong>Hurricanes U13 C-Jugend:</strong><br />Steffi Fidorra / Isa Giesen<br /><a
                  href="javascript:linkTo_UnCryptMailto('gxd3q79Vxwhpey3dqnneywjao4za', -22)"
                  >kbh-u13 (at) baltic-hurricanes.de</a
                ><br /><br /><strong>Kiel Baltic Hurricanes II:</strong><br />Tim Kohl<br /><a
                  href="javascript:linkTo_UnCryptMailto('n2eibfTvufncw1bollcwuhym2xy', -20)"
                  >t.kohl (at) baltic-hurricanes.de</a
                ><br />0172 - 456 4445<br /><br /><strong>Kiel Baltic Hurricanes Ladies:</strong><br />Anna Bilitewski
                &amp; Alex Acar<br /><a href="javascript:linkTo_UnCryptMailto('hwzeaoVxwhpey3dqnneywjao4za', -22)"
                  >ladies (at) baltic-hurricanes.de</a
                ><br /><br /><strong>Kiel Baltic Flag Hurricanes:</strong><br />Mara Steiner &amp; &nbsp;Jan Hynes<br /><a
                  href="javascript:linkTo_UnCryptMailto('vbqwiPrqbjys-xkhhysqdui.tu', -16)"
                  >flags (at) baltic-hurricanes.de</a
                ><br />0171 - 321 5112<br /><br /><strong>Schiedsrichter:</strong><br />Dietmar Reichow<br /><a
                  href="javascript:linkTo_UnCryptMailto('refsZbaltic7hurricanes8de', -26)"
                  >refs (at) baltic-hurricanes.de</a
                >
              </p>
            </div>
          </div>
          <h2 class="rich-text uppercase">Satzung</h2>
          <div class="c-rich-text neos-nodetypes-text">
            <div>
              <p>
                Die Satzung des American Sports Club Kiel e.V. könnt ihr Euch hier herunterladen:<br /><a
                  href="https://www.baltic-hurricanes.de/resources/persistent/1e60f3e8f640c6572821758e8c9d6494ce934914/1_Satzung_AMERICAN_SPORTS_CLUB_KIEL%20%281%29.pdf"
                  >Satzung ASC Kiel e.V.&nbsp;</a
                ><i>(pdf-Format, 70 kb)</i>
              </p>
            </div>
          </div>
        </div>
        <div class="mt-8 px-4 text-right"></div>
      </div>
    </section>

    <div class="md:max-w-[677px] mx-auto px-4 pt-4 pb-20 md:px-0 md:mt-4 text-white">
      <h1 class="font-bold mb-10 typography-headline-3 md:typography-headline-2">
        {{ t('contact.contact') }}
      </h1>
      <p class="mb-10">{{ t('contact.contactShopMessage') }}</p>

      <form data-testid="contact-form" class="flex flex-col rounded-md gap-4" @submit.prevent="onSubmit" novalidate>
        <div class="">
          <label>
            <UiFormLabel class="mb-1">{{ t('contact.form.nameLabel') }} {{ t('form.required') }}</UiFormLabel>
            <SfInput
              v-bind="nameAttributes"
              name="name"
              type="text"
              v-model="name"
              :invalid="Boolean(errors['name'])"
            />
          </label>
          <ErrorMessage as="div" name="name" class="text-negative-700 text-left text-sm pt-[0.2rem]" />
        </div>
        <div class="">
          <label>
            <UiFormLabel class="mb-1">{{ t('contact.form.emailLabel') }} {{ t('form.required') }}</UiFormLabel>

            <SfInput
              name="email"
              type="email"
              autocomplete="email"
              v-bind="emailAttributes"
              v-model="email"
              :invalid="Boolean(errors['email'])"
            >
              <template #prefix>
                <SfIconEmail />
              </template>
            </SfInput>
          </label>
          <ErrorMessage as="div" name="email" class="text-negative-700 text-left text-sm pt-[0.2rem]" />
        </div>
        <label>
          <UiFormLabel class="mb-1">{{ t('contact.form.subjectLabel') }} {{ t('form.required') }}</UiFormLabel>
          <SfInput name="subject" type="text" v-model="subject" v-bind="subjectAttributes" />
          <ErrorMessage as="div" name="subject" class="text-negative-700 text-left text-sm pt-[0.2rem]" />
        </label>
        <label>
          <UiFormLabel class="mb-1">{{ t('contact.form.order-id') }} {{ t('form.required') }}</UiFormLabel>
          <SfInput name="order-id" type="text" v-model="orderId" v-bind="orderIdAttributes" />
          <ErrorMessage as="div" name="orderId" class="text-negative-700 text-left text-sm pt-[0.2rem]" />
        </label>

        <div>
          <label class="flex flex-col">
            <UiFormLabel class="mb-1">{{ t('contact.form.message') }} {{ t('form.required') }}</UiFormLabel>
            <SfTextarea
              :placeholder="t('contact.form.message-placeholder')"
              class="w-full"
              name="message"
              v-bind="messageAttributes"
              v-model="message"
              :invalid="Boolean(errors['message'])"
              required
            />
          </label>
          <ErrorMessage as="div" name="message" class="text-negative-700 text-left text-sm pt-[0.2rem]" />
        </div>

        <div>
          <div class="flex items-center">
            <SfCheckbox
              :invalid="Boolean(errors['privacyPolicy'])"
              id="terms"
              v-model="privacyPolicy"
              v-bind="privacyPolicyAttributes"
              value="value"
              class="peer"
              required
            />
            <label
              class="ml-3 text-base text-white cursor-pointer peer-disabled:text-disabled-900 select-none"
              for="terms"
            >
              <i18n-t keypath="contact.privacyPolicy" scope="global">
                <template #privacyPolicy>
                  <SfLink
                    :href="localePath(paths.privacyPolicy)"
                    target="_blank"
                    class="focus:outline focus:outline-offset-2 focus:outline-2 outline-secondary-600 rounded"
                  >
                    {{ t('privacyPolicy') }}
                  </SfLink>
                </template>
              </i18n-t>
              {{ t('form.required') }}
            </label>
          </div>
          <ErrorMessage as="div" name="privacyPolicy" class="text-negative-700 text-left text-sm pt-[0.2rem]" />
        </div>

        <p class="text-sm text-neutral-500 mb-2">{{ t('form.required') }} {{ t('contact.form.asterixHint') }}</p>

        <div class="md:col-span-3 flex flex-col-reverse md:flex-row justify-end gap-4">
          <UiButton type="button" variant="secondary" :disabled="isContactLoading" @click="clearInputs">
            {{ t('contact.clearAll') }}
          </UiButton>
          <UiButton data-testid="save-address" type="submit" class="min-w-[120px]" :disabled="isContactLoading">
            <SfLoaderCircular v-if="isContactLoading" class="flex justify-center items-center" size="sm" />
            <span v-else>
              {{ t('contact.contactSend') }}
            </span>
          </UiButton>
        </div>

        <div>
          <NuxtTurnstile
            v-if="turnstileSiteKey"
            v-model="turnstile"
            v-bind="turnstileAttributes"
            ref="turnstileElement"
            :options="{ theme: 'light' }"
            class="mt-4"
          />
          <ErrorMessage as="div" name="turnstile" class="text-negative-700 text-left text-sm pt-[0.2rem]" />
        </div>
      </form>
    </div>
  </NuxtLayout>
</template>

<script setup lang="ts">
import { SfInput, SfCheckbox, SfLink, SfTextarea, SfLoaderCircular, SfIconEmail } from '@storefront-ui/vue';
import { boolean, object, string } from 'yup';
import { useForm, ErrorMessage } from 'vee-validate';
import { toTypedSchema } from '@vee-validate/yup';
import { paths } from '~/utils/paths';
// import {  } from 'nuxt/app';

definePageMeta({
  layout: false,
});

useHead({
  title: 'Kontakt',
});

const runtimeConfig = useRuntimeConfig();

const { t } = useI18n();
const { loading: isContactLoading, doCustomerContactMail } = useCustomerContact();
const localePath = useLocalePath();
const turnstileSiteKey = runtimeConfig.public?.turnstileSiteKey ?? '';
const turnstileElement = ref();
const { send } = useNotification();

const validationSchema = toTypedSchema(
  object({
    name: string().required(t('errorMessages.contact.nameRequired')).default(''),
    email: string().email(t('errorMessages.email.valid')).required(t('errorMessages.email.required')).default(''),
    message: string().required(t('errorMessages.contact.messageRequired')).default(''),
    subject: string().required(t('errorMessages.requiredField')).default(''),
    orderId: string()
      .required(t('errorMessages.requiredField'))
      .test((value, context) => {
        if (value && /\D/.test(value)) {
          return context.createError({ message: t('errorMessages.wholeNumber') });
        }
        return true;
      }),
    privacyPolicy: boolean().oneOf([true], t('errorMessages.contact.termsRequired')).default(false),
    turnstile: string().required(t('errorMessages.contact.turnstileRequired')).default(''),
  }),
);

const { errors, meta, defineField, handleSubmit, resetForm } = useForm({
  validationSchema: validationSchema,
});

const [name, nameAttributes] = defineField('name');
const [email, emailAttributes] = defineField('email');
const [subject, subjectAttributes] = defineField('subject');
const [orderId, orderIdAttributes] = defineField('orderId');
const [message, messageAttributes] = defineField('message');
const [privacyPolicy, privacyPolicyAttributes] = defineField('privacyPolicy');
const [turnstile, turnstileAttributes] = defineField('turnstile');

const clearInputs = () => {
  name.value = '';
  email.value = '';
  message.value = '';
  orderId.value = '';
  subject.value = '';
  privacyPolicy.value = false;
};

const sendContact = async () => {
  if (!meta.value.valid || !turnstile.value) {
    return;
  }

  const params = {
    name: name?.value || '',
    email: email?.value || '',
    subject: subject?.value || '',
    orderId: orderId?.value || '',
    message: message.value || '',
    'cf-turnstile-response': turnstile.value,
  };

  if (await doCustomerContactMail(params)) {
    send({
      type: 'positive',
      message: t('contact.success'),
    });
    resetForm();
  }

  turnstile.value = '';
  turnstileElement.value?.reset();
};

const onSubmit = handleSubmit(() => sendContact());
</script>
<style scoped>
a {
  color: #f47d30;
  font-weight: bold;
}
a:hover {
  color: white;
}
</style>
